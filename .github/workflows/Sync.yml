name: Sync BetterGI Release to Gitee

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  GH_API_URL: "https://api.github.com/repos/kaedelcb/better-genshin-impact/actions/workflows/publish.yml/runs?status=success&per_page=1"
  DOWNLOAD_BASE_URL: "https://nightly.link/kaedelcb/better-genshin-impact/actions/runs"
  GITEE_REPO: "bcmdy_ms/BetterGI-lcb"

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出当前仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 获取最新 Workflow 信息
        id: fetch_workflow
        run: |
          RESPONSE=$(curl -s "${{ env.GH_API_URL }}")
          WORKFLOW_ID=$(echo "$RESPONSE" | jq -r '.workflow_runs[0].id')
          WORKFLOW_NAME=$(echo "$RESPONSE" | jq -r '.workflow_runs[0].name')
          
          echo "WORKFLOW_ID=$WORKFLOW_ID" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "最新工作流: $WORKFLOW_NAME (ID: $WORKFLOW_ID)"

      - name: 读取并比较 ID
        id: check_update
        run: |
          ID_FILE=".last-workflow-id"
          SAVED_ID=$(cat "$ID_FILE" 2>/dev/null || echo "none")
          
          echo "本地保存的ID: $SAVED_ID"
          echo "远程最新的ID: ${{ env.WORKFLOW_ID }}"
          
          if [ "$SAVED_ID" = "${{ env.WORKFLOW_ID }}" ]; then
            echo "NEED_UPDATE=false" >> $GITHUB_ENV
            echo "✅ 版本已是最新，无需同步"
          else
            echo "NEED_UPDATE=true" >> $GITHUB_ENV
            echo "⚠️ 检测到新版本，准备同步..."
          fi

      - name: 下载更新文件
        if: env.NEED_UPDATE == 'true'
        run: |
          echo "${{ env.WORKFLOW_ID }}" > .last-workflow-id
          DOWNLOAD_URL="${{ env.DOWNLOAD_BASE_URL }}/${{ env.WORKFLOW_ID }}/BetterGI_7z.zip"
          
          echo "📥 开始下载: $DOWNLOAD_URL"
          curl -L --progress-bar -o BetterGI_7z.zip "$DOWNLOAD_URL" 2>&1 | tee download.log
          
          FILE_SIZE=$(ls -lh BetterGI_7z.zip | awk '{print $5}')
          echo "✅ 下载完成，文件大小: $FILE_SIZE"

      - name: 配置 Git 和 Gitee 认证
        if: env.NEED_UPDATE == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git remote add gitee https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ env.GITEE_REPO }}.git 2>/dev/null || \
          git remote set-url gitee https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ env.GITEE_REPO }}.git

      - name: 推送到 GitHub（只更新 ID 文件）
        if: env.NEED_UPDATE == 'true'
        run: |
          git add .last-workflow-id
          git commit -m "Update workflow ID: ${{ env.WORKFLOW_NAME }} (${{ env.WORKFLOW_ID }})" \
                     -m "Sync time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          echo "📤 正在推送到 GitHub（只更新 ID 文件）..."
          git push origin HEAD:${{ github.ref_name }}

      - name: 推送到 Gitee（带估算进度显示）
        if: env.NEED_UPDATE == 'true'
        run: |
          # 如果工作树干净，先重置
          if git diff-index --quiet HEAD; then
            echo "工作树干净，重置提交..."
            git reset --soft HEAD~1
          fi
          
          # 添加完整内容并修改提交
          git add .last-workflow-id BetterGI_7z.zip
          git commit --amend --no-edit
          
          # 获取文件大小用于估算
          TOTAL_SIZE=$(stat -c%s "BetterGI_7z.zip" 2>/dev/null || stat -f%z "BetterGI_7z.zip" 2>/dev/null || echo "0")
          TOTAL_MB=$((TOTAL_SIZE / 1024 / 1024))
          
          echo ""
          echo "📤 开始推送到 Gitee..."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📦 待推送文件: BetterGI_7z.zip (${TOTAL_MB} MB)"
          echo "⏱️  预计时间: ~$((TOTAL_MB / 50))-$((TOTAL_MB / 30)) 秒"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          # 后台运行真实推送
          stdbuf -oL -eL git -c http.postBuffer=2097152000 push gitee HEAD:master --force --verbose > /tmp/push.log 2>&1 &
          PUSH_PID=$!
          START_TIME=$(date +%s)
          
          # 显示估算进度（每5秒更新一次）
          while kill -0 $PUSH_PID 2>/dev/null; do
            ELAPSED=$(( $(date +%s) - START_TIME ))
            ELAPSED=$((ELAPSED + 1))  # 避免除零
            
            # 基于时间的估算进度 (假设平均速度 30-50 MB/s)
            EST_SPEED=$(( 30 + RANDOM % 20 ))  # 30-49 MB/s 随机值
            EST_UPLOADED=$((ELAPSED * EST_SPEED))
            
            if [ $EST_UPLOADED -gt $TOTAL_MB ]; then
              EST_PERCENT=95  # 接近完成但不到100%
            elif [ $TOTAL_MB -gt 0 ]; then
              EST_PERCENT=$((EST_UPLOADED * 100 / TOTAL_MB))
            else
              EST_PERCENT=0
            fi
            
            # 限制百分比最大为95
            if [ $EST_PERCENT -gt 95 ]; then
              EST_PERCENT=95
            fi
            
            # 生成进度条（使用ASCII字符 = 和 -）
            BAR_LEN=30
            FILLED_LEN=$((EST_PERCENT * BAR_LEN / 100))
            EMPTY_LEN=$((BAR_LEN - FILLED_LEN))
            
            # 使用纯ASCII字符显示进度条
            printf "\r  ⏳ 推送中 ["
            printf "%0.s=" $(seq 1 $FILLED_LEN)
            printf "%0.s-" $(seq 1 $EMPTY_LEN)
            printf "] %3d%% | %d/%d MB | 已用 %ds" \
              "$EST_PERCENT" \
              "$((EST_UPLOADED < TOTAL_MB ? EST_UPLOADED : TOTAL_MB))" \
              "$TOTAL_MB" \
              "$ELAPSED"
            
            sleep 5
          done
          
          # 等待进程完成
          wait $PUSH_PID
          PUSH_EXIT_CODE=$?
          
          echo ""  # 结束进度条行
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          
          if [ $PUSH_EXIT_CODE -eq 0 ]; then
            echo "✅ Gitee 推送成功完成！"
            echo ""
            echo "📊 推送统计:"
            grep -E "(Total|delta|reused|pack-reused)" /tmp/push.log | head -5 || echo "  (详细统计获取失败)"
          else
            echo "❌ Gitee 推送失败，退出码: $PUSH_EXIT_CODE"
            echo ""
            echo "📝 错误详情:"
            tail -20 /tmp/push.log
            exit $PUSH_EXIT_CODE
          fi

      - name: 在 Gitee 创建发布
        if: env.NEED_UPDATE == 'true'
        uses: actions/github-script@v7
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        with:
          script: |
            const workflowId = process.env.WORKFLOW_ID;
            const workflowName = process.env.WORKFLOW_NAME;
            
            console.log(`🚀 正在 Gitee 创建发布...`);
            console.log(`   名称: ${workflowName}`);
            console.log(`   ID: ${workflowId}`);
            
            const releaseData = {
              tag_name: `sync-${workflowId}`,
              name: `Sync: ${workflowName}`,
              body: `自动同步自 GitHub Workflow\n\n- **Workflow名称**: ${workflowName}\n- **Workflow ID**: ${workflowId}\n- **同步时间**: ${new Date().toISOString()}`,
              prerelease: false,
              target_commitish: 'master'
            };
            
            try {
              const response = await fetch(`https://gitee.com/api/v5/repos/${process.env.GITEE_REPO}/releases`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `token ${process.env.GITEE_TOKEN}`
                },
                body: JSON.stringify(releaseData)
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Gitee API error: ${response.status} - ${errorText}`);
              }
              
              const data = await response.json();
              console.log(`✅ Release 创建成功: ${data.html_url}`);
            } catch (error) {
              console.error(`❌ 创建 Release 失败: ${error.message}`);
            }