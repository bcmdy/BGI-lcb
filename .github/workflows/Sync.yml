name: Sync BetterGI Release to Gitee

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  GH_API_URL: "https://api.github.com/repos/kaedelcb/better-genshin-impact/actions/workflows/publish.yml/runs?status=success&per_page=1"
  DOWNLOAD_BASE_URL: "https://nightly.link/kaedelcb/better-genshin-impact/actions/runs"
  GITEE_REPO: "bcmdy_ms/BetterGI-lcb"

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–æœ€æ–° Workflow ä¿¡æ¯
        id: fetch_workflow
        run: |
          RESPONSE=$(curl -s "${{ env.GH_API_URL }}")
          WORKFLOW_ID=$(echo "$RESPONSE" | jq -r '.workflow_runs[0].id')
          WORKFLOW_NAME=$(echo "$RESPONSE" | jq -r '.workflow_runs[0].name')
          
          echo "WORKFLOW_ID=$WORKFLOW_ID" >> $GITHUB_ENV
          echo "WORKFLOW_NAME=$WORKFLOW_NAME" >> $GITHUB_ENV
          echo "æœ€æ–°å·¥ä½œæµ: $WORKFLOW_NAME (ID: $WORKFLOW_ID)"

      - name: è¯»å–å¹¶æ¯”è¾ƒ ID
        id: check_update
        run: |
          ID_FILE=".last-workflow-id"
          SAVED_ID=$(cat "$ID_FILE" 2>/dev/null || echo "none")
          
          echo "æœ¬åœ°ä¿å­˜çš„ID: $SAVED_ID"
          echo "è¿œç¨‹æœ€æ–°çš„ID: ${{ env.WORKFLOW_ID }}"
          
          if [ "$SAVED_ID" = "${{ env.WORKFLOW_ID }}" ]; then
            echo "NEED_UPDATE=false" >> $GITHUB_ENV
            echo "âœ… ç‰ˆæœ¬å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
          else
            echo "NEED_UPDATE=true" >> $GITHUB_ENV
            echo "âš ï¸ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œå‡†å¤‡åŒæ­¥..."
          fi

      - name: ä¸‹è½½æ›´æ–°æ–‡ä»¶
        if: env.NEED_UPDATE == 'true'
        run: |
          echo "${{ env.WORKFLOW_ID }}" > .last-workflow-id
          DOWNLOAD_URL="${{ env.DOWNLOAD_BASE_URL }}/${{ env.WORKFLOW_ID }}/BetterGI_7z.zip"
          
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½: $DOWNLOAD_URL"
          curl -L --progress-bar -o BetterGI_7z.zip "$DOWNLOAD_URL" 2>&1 | tee download.log
          
          FILE_SIZE=$(ls -lh BetterGI_7z.zip | awk '{print $5}')
          echo "âœ… ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $FILE_SIZE"

      - name: é…ç½® Git å’Œ Gitee è®¤è¯
        if: env.NEED_UPDATE == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git remote add gitee https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ env.GITEE_REPO }}.git 2>/dev/null || \
          git remote set-url gitee https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ env.GITEE_REPO }}.git

      - name: æ¨é€åˆ° GitHubï¼ˆåªæ›´æ–° ID æ–‡ä»¶ï¼‰
        if: env.NEED_UPDATE == 'true'
        run: |
          git add .last-workflow-id
          git commit -m "Update workflow ID: ${{ env.WORKFLOW_NAME }} (${{ env.WORKFLOW_ID }})" \
                     -m "Sync time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          echo "ğŸ“¤ æ­£åœ¨æ¨é€åˆ° GitHubï¼ˆåªæ›´æ–° ID æ–‡ä»¶ï¼‰..."
          git push origin HEAD:${{ github.ref_name }}

      - name: æ¨é€åˆ° Giteeï¼ˆå¸¦ä¼°ç®—è¿›åº¦æ˜¾ç¤ºï¼‰
        if: env.NEED_UPDATE == 'true'
        run: |
          # å¦‚æœå·¥ä½œæ ‘å¹²å‡€ï¼Œå…ˆé‡ç½®
          if git diff-index --quiet HEAD; then
            echo "å·¥ä½œæ ‘å¹²å‡€ï¼Œé‡ç½®æäº¤..."
            git reset --soft HEAD~1
          fi
          
          # æ·»åŠ å®Œæ•´å†…å®¹å¹¶ä¿®æ”¹æäº¤
          git add .last-workflow-id BetterGI_7z.zip
          git commit --amend --no-edit
          
          # è·å–æ–‡ä»¶å¤§å°ç”¨äºä¼°ç®—
          TOTAL_SIZE=$(stat -c%s "BetterGI_7z.zip" 2>/dev/null || stat -f%z "BetterGI_7z.zip" 2>/dev/null || echo "0")
          TOTAL_MB=$((TOTAL_SIZE / 1024 / 1024))
          
          echo ""
          echo "ğŸ“¤ å¼€å§‹æ¨é€åˆ° Gitee..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ å¾…æ¨é€æ–‡ä»¶: BetterGI_7z.zip (${TOTAL_MB} MB)"
          echo "â±ï¸  é¢„è®¡æ—¶é—´: ~$((TOTAL_MB / 50))-$((TOTAL_MB / 30)) ç§’"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # åå°è¿è¡ŒçœŸå®æ¨é€
          git -c http.postBuffer=2097152000 push gitee HEAD:master --force --verbose > /tmp/push.log 2>&1 &
          PUSH_PID=$!
          START_TIME=$(date +%s)
          
          # æ˜¾ç¤ºä¼°ç®—è¿›åº¦ï¼ˆæ¯5ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
          while kill -0 $PUSH_PID 2>/dev/null; do
            ELAPSED=$(( $(date +%s) - START_TIME ))
            ELAPSED=$((ELAPSED + 1))  # é¿å…é™¤é›¶
            
            # ä½¿ç”¨ä¿å®ˆçš„é€Ÿåº¦ä¼°ç®—ï¼ˆ20-35 MB/sï¼‰
            EST_SPEED=$(( 20 + RANDOM % 15 ))
            EST_UPLOADED=$((ELAPSED * EST_SPEED))
            
            # é™åˆ¶æœ€å¤§ä¼°ç®—å€¼ï¼Œè®©è¿›åº¦èƒ½å¹³æ»‘å¢é•¿åˆ°99%
            if [ $EST_UPLOADED -gt $TOTAL_MB ]; then
              # å¦‚æœä¼°ç®—è¶…è¿‡å®é™…å¤§å°ï¼Œæ ¹æ®æ—¶é—´ç¼“æ…¢å¢åŠ è¿›åº¦åˆ°99%
              OVER_TIME=$((ELAPSED - (TOTAL_MB / EST_SPEED)))
              
              # 30ç§’åå¼€å§‹ç¼“æ…¢å¢åŠ è¿›åº¦
              if [ $OVER_TIME -gt 30 ]; then
                EST_PERCENT=$((95 + (OVER_TIME - 30) / 3))  # æ¯3ç§’å¢åŠ 1%
                if [ $EST_PERCENT -gt 99 ]; then
                  EST_PERCENT=99
                fi
              else
                EST_PERCENT=95  # å‰30ç§’ä¿æŒåœ¨95%
              fi
              
              EST_UPLOADED=$TOTAL_MB  # æ˜¾ç¤ºå®Œæ•´å¤§å°
              STATUS_TEXT="æ­£åœ¨å®Œæˆ..."
            else
              EST_PERCENT=$((EST_UPLOADED * 100 / TOTAL_MB))
              STATUS_TEXT="ä¸Šä¼ ä¸­..."
            fi
            
            # ä½¿ç”¨çº¯ASCIIå­—ç¬¦æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆé¿å…ä»»ä½•Unicodeï¼‰
            BAR_LEN=30
            FILLED_LEN=$((EST_PERCENT * BAR_LEN / 100))
            EMPTY_LEN=$((BAR_LEN - FILLED_LEN))
            
            # ä½¿ç”¨ç®€å•å¾ªç¯ç”ŸæˆASCIIå­—ç¬¦ï¼ˆä¸ä½¿ç”¨seqï¼‰
            BAR="["
            i=0
            while [ $i -lt $FILLED_LEN ]; do
              BAR="${BAR}="
              i=$((i + 1))
            done
            
            i=0
            while [ $i -lt $EMPTY_LEN ]; do
              BAR="${BAR}-"
              i=$((i + 1))
            done
            BAR="${BAR}]"
            
            # æ‰“å°è¿›åº¦ï¼ˆä½¿ç”¨echoè€Œä¸æ˜¯printfé¿å…ç¼–ç é—®é¢˜ï¼‰
            echo -ne "\r  â³ æ¨é€ä¸­ ${BAR} ${EST_PERCENT}% | ${EST_UPLOADED}/${TOTAL_MB} MB | å·²ç”¨ ${ELAPSED}s | ${STATUS_TEXT}   "
            
            sleep 5
          done
          
          # ç­‰å¾…è¿›ç¨‹å®Œæˆ
          wait $PUSH_PID
          PUSH_EXIT_CODE=$?
          
          echo ""  # ç»“æŸè¿›åº¦æ¡è¡Œ
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ $PUSH_EXIT_CODE -eq 0 ]; then
            echo "âœ… Gitee æ¨é€æˆåŠŸå®Œæˆï¼"
            echo ""
            echo "ğŸ“Š æ¨é€ç»Ÿè®¡:"
            grep -E "(Total|delta|reused|pack-reused)" /tmp/push.log | head -5 || echo "  (è¯¦ç»†ç»Ÿè®¡è·å–å¤±è´¥)"
          else
            echo "âŒ Gitee æ¨é€å¤±è´¥ï¼Œé€€å‡ºç : $PUSH_EXIT_CODE"
            echo ""
            echo "ğŸ“ é”™è¯¯è¯¦æƒ…:"
            tail -20 /tmp/push.log
            exit $PUSH_EXIT_CODE
          fi

      - name: åœ¨ Gitee åˆ›å»ºå‘å¸ƒ
        if: env.NEED_UPDATE == 'true'
        uses: actions/github-script@v7
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        with:
          script: |
            const workflowId = process.env.WORKFLOW_ID;
            const workflowName = process.env.WORKFLOW_NAME;
            
            console.log(`ğŸš€ æ­£åœ¨ Gitee åˆ›å»ºå‘å¸ƒ...`);
            console.log(`   åç§°: ${workflowName}`);
            console.log(`   ID: ${workflowId}`);
            
            const releaseData = {
              tag_name: `sync-${workflowId}`,
              name: `Sync: ${workflowName}`,
              body: `è‡ªåŠ¨åŒæ­¥è‡ª GitHub Workflow\n\n- **Workflowåç§°**: ${workflowName}\n- **Workflow ID**: ${workflowId}\n- **åŒæ­¥æ—¶é—´**: ${new Date().toISOString()}`,
              prerelease: false,
              target_commitish: 'master'
            };
            
            try {
              const response = await fetch(`https://gitee.com/api/v5/repos/${process.env.GITEE_REPO}/releases`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `token ${process.env.GITEE_TOKEN}`
                },
                body: JSON.stringify(releaseData)
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Gitee API error: ${response.status} - ${errorText}`);
              }
              
              const data = await response.json();
              console.log(`âœ… Release åˆ›å»ºæˆåŠŸ: ${data.html_url}`);
            } catch (error) {
              console.error(`âŒ åˆ›å»º Release å¤±è´¥: ${error.message}`);
            }